name: Build and deploy to development

on:
  release:
    types: [created]
  workflow_dispatch:

jobs:
  mirror:
    name: Sync repo for build image
    runs-on: ubuntu-latest
    steps:
      - name: Checks-out repository
        uses: actions/checkout@v3
      - name: Send a sync request to DSO api
        run: |
          curl -X POST --fail -F token=${{ secrets.GITLAB_TRIGGER_TOKEN }} -F ref=${{vars.BRANCH_SYNC}} -F "variables[GIT_BRANCH_DEPLOY]=main" -F variables[PROJECT_NAME]=biblio-num ${{vars.URL_MIRROR}}

  integration-deploy:
    name: Sync repo for deploy to development
    runs-on: ubuntu-latest
    steps:
      - name: Checks-out repository
        uses: actions/checkout@v3
      - name: Update version
        uses: ./.github/actions/ci-update-deploy-tag
        with:
          token: ${{ secrets.DSO_BIBLIO_NUME_DEPLOY_TOKEN }}
          owner: dnum-mi
          repo: dso-bibliotheque-numerique-deploy
          branch: dev
          path: base/deployment.yaml
      - name: Send a sync request to DSO api
        run: |
          curl -X POST --fail -F token=${{ secrets.GITLAB_DEPLOY_TRIGGER_TOKEN }} -F ref=${{vars.BRANCH_SYNC}} -F "variables[GIT_BRANCH_DEPLOY]=dev" -F variables[PROJECT_NAME]=bn-deploy ${{vars.DEPLOY_URL_MIRROR}}
