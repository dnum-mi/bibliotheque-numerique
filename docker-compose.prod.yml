services:
  biblio-num-prod:
    build:
      context: .
      dockerfile: Dockerfile
    image: biblio-num:prod
    container_name: biblio-num-prod
    environment:
      BIBLIO-NUM_SERVER: biblio-num-prod_server
      BIBLIO-NUM_CLIENT: biblio-num-prod_client
    depends_on:
      - client
      - server
    ports:
      - "${BIBLIO_NUM_PORT:-80}:8080"
    networks:
      - biblio-num-prod-network

  client: 
    build:
      target: production
      context: client
      dockerfile: Dockerfile
    image: biblio-num/client:prod
    container_name: biblio-num-prod_client
    networks:
      - biblio-num-prod-network

  server:
    build:
      target: production
      context: server
      dockerfile: Dockerfile
    image: biblio-num/server:prod
    container_name: biblio-num-prod_server
    depends_on:
      - db
    ports:
      - 3000:3000
    networks:
      - biblio-num-prod-network
    environment:
      POSTGRES_HOST: ${POSTGRES_HOST:-db}
      POSTGRES_DB: ${POSTGRES_DB:-biblio-num}
      POSTGRES_USERNAME: ${POSTGRES_USER}
      POSTGRES_PORT: ${POSTGRES_PORT}
      POSTGRES_PASSWORD: ${POSTGRES_USER}
      DS_API_URL: ${DS_API_URL}
      DS_API_TOKEN: ${DS_API_TOKEN}
      SMTP_SERVER: ${SMTP_SERVER:-localhost}
      SMTP_PORT: ${SMTP_PORT:- 1025}
      LOG_DATE_FORMAT: "DD/MM/YYYY HH:mm:ss"
      JWT_SECRET: ${JWT_SECRET:-biblio-num-jwt-secret}
      SESSION_SECRET: ${SESSION_SECRET:-biblio-num-session-secret}
      FILE_DRIVER: ${FILE_DRIVER:-local}

  db:
    image: postgres:14.5
    container_name: biblio-num-prod_db
    restart: always
    environment:
      POSTGRES_DB: biblio-num
      POSTGRES_USER: biblio-num
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"
    networks:
      - biblio-num-prod-network
    volumes:
      - type: volume
        source: biblio-num-prod-db-volume
        target: /var/lib/postgresql/data


networks:
  biblio-num-prod-network:
    name: biblio-num-prod-network
    driver: bridge
    driver_opts:
      com.docker.network.driver.mtu: 1450

volumes:
  biblio-num-prod-db-volume: